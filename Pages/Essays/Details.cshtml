@page "{essayId}"
@model Lingo.Pages.Essays.DetailsModel
@using Lingo.Services
@inject Auth auth

<div id="app" class="row">
    <!-- Essay -->
    <div class="col-6">
        @if (Model.Essay != null)
        {
            <div class="row">
                <a class="btn btn-primary" asp-page="./Edit" asp-route-essayId="@Model.Essay.EssayId">Edit</a>
                <form asp-page-handler="delete" asp-route-essayId="@Model.Essay.EssayId" method="post">
                    <button class="btn btn-danger">Delete</button>
                </form>
            </div>  
        }
        <h3 class="mt-3">@Model.Essay.Title</h3> 
        <div>
            <span>@Model.Essay.EssayId</span> |
            <span>@Model.Essay.Category</span> |
            <span>@Model.Essay.Language</span> |
            <span>@Model.Essay.Source</span> |
            @*<span>@Model.Essay.Created.Value.ToString("dd MMM yyyy")</span>
        </div>*@
        <div class="border mt-2 p-2">
           <span id="text">@Html.Raw(@Model.Essay.Text)</span>
        </div>

    </div>
    <!-- Vocab list -->
     <div class="col-6">
        <h1>Vocabulary List</h1>
        <div>
            <div class="mb-2">
                <button type="button" class="btn btn-primary" v-on:click="addingVocabFromEssay">Add</button>
            </div>
            <div v-if="vocabs.length == 0" class="alert alert-info" role="alert">No vocab found!</div>
            <div class="row" v-for="(v, index) in vocabs" :key="v.vocabId">
                <div class="col-2 vocab-item" v-text="'(' + ( index + 1 ) + ')'"></div>
                <div class="col-5 vocab-item hand" v-text="v.text" v-on:click="updating(v)"></div>
                <div class="col-3 vocab-item" v-text="v.chinese"></div>
                <div class="col-2 vocab-item">
                    <button v-on:click="remove(index, v.vocabId, v.text)" >Del</button>
                </div>            
            </div>
        </div>       
    </div> <!-- vocab list -->
    <!-- modal -->
    <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">{{ vocab.vocabId ? 'Update Vocab' : 'New Vocab'}}</h5>
                    <button type="button" class="close" aria-label="Close" v-on:click="cancelAddingVocabFromEssay">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="text" class="col-form-label">Text:</label>
                            <input type="text" class="form-control" id="text" v-model="vocab.text">
                            <button type="button" class="btn btn-primary" v-on:click="translate">Google Translate</button>
                        </div>
                        <div class="form-group">
                            <label for="chinese" class="col-form-label">Chinese:</label>
                            <input type="text" class="form-control" id="chinese" v-model="vocab.chinese">
                        </div>
                        <div class="form-group">
                            <label for="note" class="col-form-label">Note:</label>
                            <textarea rows="5" type="text" class="form-control" id="note" v-model="vocab.note"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" v-on:click="cancelAddingVocabFromEssay">Close</button>
                    <button type="button" class="btn btn-primary" v-on:click="upsert">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{ 
    <script>
        // has to embed vue.js in this view model. If linked to external js, cannot insert value from view model
        const app =  new Vue({
            el: '#app',
            data() {
            return {
                //in vue.js, all properties must start with small letter
                vocabs:[],
                isSaveEssay:false,
                vocab:{
                    language: '@Model.Essay.Language',
                    text:'',
                    chinese:'',
                    note:'',
                    essayId: @Model.Essay.EssayId,
                    category:'Essay',
                    userId:@auth.UserId,  
                    review:false,
                },
                defaultVocab:{
                    language: '@Model.Essay.Language',
                    text:'',
                    chinese:'',
                    note:'',
                    essayId: @Model.Essay.EssayId,
                    category:'Essay',
                    userId:@auth.UserId,
                    review:false,
                },
            }
            },
            created(){
                this.loadVocabList()
            },
            methods:{
                loadVocabList(){
                    fetch('../../api/vocab/essay/@Model.Essay.EssayId')
                        .then(response => response.json())
                        .then(response => {
                            this.vocabs = response.data
                            this.syncVocabIndex()
                        })
                        // ajax not working           
                },
                loadEssayText(){
                    fetch('../../api/essay/@Model.Essay.EssayId')
                        .then(response => response.json())
                        .then(response => {
                            $('#text').html(response.text)
                        })
                },
                adding(){
                    this.vocab = {...this.defaultVocab}
                    console.log('vocab', this.vocab)
                    $('#modal').modal('show')
                },
                updating(v){
                    this.vocab = {...v}
                    $('#modal').modal('show')
                },
                upsert(){
                    let operation = 'POST'
                    // first letter convert to capital letter
                    const vocab = {
                        Language: this.vocab.language,
                        Text:this.vocab.text,
                        Chinese:this.vocab.chinese,
                        Note:this.vocab.note,                
                        EssayId: this.vocab.essayId,
                        Category:this.vocab.category,
                        UserId:this.vocab.userId,
                        Review:this.vocab.review,
                    }
                    if (this.vocab.vocabId){
                        vocab.VocabId = this.vocab.vocabId
                        operation = 'PUT'
                    }
                    fetch('../../api/vocab',{
                        method: operation, 
                        headers: {
                        'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(vocab),
                    })
                    .then(response => response.json())
                    .then(response => {
                        this.vocab = {...this.defaultVocab}
                        this.loadVocabList()
                         $('#modal').modal('hide')
                        // update Essay if vocab is from  Essay
                        if (this.isSaveEssay){                            
                            this.saveEssay()                        
                        }
                    })
                },
                remove(index, vocabId, text){
                    // remove highlighted vocab in essay
                    $('.index').each(function() {
                        if ($(this).html() == index + 1){
                            $(this).parent().replaceWith(text)
                        }
                    })
                    //refresh all index
                    let n = 1
                    $('.index').each(function() {
                        $(this).html(n)
                        n++                        
                    })
                    //save essay to db
                    this.saveEssay()
                    
                    // remove vocab in db
                    fetch('../../api/vocab/'+vocabId,{ method:'delete'})
                    .then(response => response.json())
                    .then(response => {
                        this.loadVocabList()
                        toastr.options = {
                            timeOut: "1000",
                        }
                        toastr.success('Deleted')
                    })
                },
                saveEssay(){
                    // update Essay API
                    this.isSaveEssay = false
                    fetch('../../api/essay/@Model.Essay.EssayId',{
                        method: 'PUT', 
                        headers: {
                        'Content-Type': 'application/json',
                        },
                        body: JSON.stringify($('#text').html())
                    })    
                },

                cancelAddingVocabFromEssay(){
                    this.loadEssayText()
                    this.vocab = {...this.defaultVocab}
                    $('#modal').modal('hide')
                },

                addingVocabFromEssay(){
                    const selection = window.getSelection().toString()
                    if (selection){
                        this.vocab = {...this.defaultVocab}
                        this.vocab.text = selection
                        // number and bold the selected text
                        insertSurroundingTagAtSelection()
                        //this.lastIndex++

                        //refresh all index
                        let n = 1
                        $('.index').each(function() {
                            $(this).html(n)
                            n++                        
                        })
                        //clear selection in essay
                        window.getSelection().empty() 
                        this.isSaveEssay = true
                        $('#modal').modal('show')
                    }else{
                        alert("Please select a vocab first")
                    }
                },

                syncVocabIndex(){ 
                    $('.index').each(function() {
                        const index = $(this).html()
                        const vocab = $(this).siblings().html()
                        // assign index from Essay to Vocab List
                        app.vocabs.map((v) =>{                            
                            if (v.text == vocab){
                                v.sn = index
                            }
                            return v
                        })                        
                    })
                    // sort by sn
                    this.vocabs.sort((a, b) => a.sn -  b.sn) 
                },

                translate(){
                    const sourceText = this.vocab.text                    
                    fetch(`../../api/vocab/translate/${sourceText}`)
                    .then(response => response.json())
                    .then(response => {
                        const obj = JSON.parse(response);
                        const result = obj.data.translations[0].translatedText
                        this.vocab.chinese = result                        
                    })
                }
            }
        })
    </script>
}


